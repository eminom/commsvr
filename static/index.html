<body>
<head>
    <script type="text/javascript">
        function uploadAndSubmit() {
            var form = document.forms["demoForm"];

            if (form["file"].files.length > 0) {
                var file = form["file"].files[0];
                // try sending
                var reader = new FileReader();

                reader.onloadstart = function() {
                    console.log("onloadstart");
                    document.getElementById("bytesTotal").textContent = file.size;
                };

                reader.onprogress = function(p) {
                    console.log("onprogress");
                    document.getElementById("bytesRead").textContent = p.loaded;
                };

                reader.onload = function() {
                    console.log("load complete");
                };

                reader.onloadend = function() {
                    // This triggers no matter succeeds or fails.
                    if (reader.error) {
                        console.log(reader.error);
                    } else {
                        document.getElementById("bytesRead").textContent = file.size;
                        var xhr = new XMLHttpRequest;
                        xhr.open(
                                "POST",                                 // method
                                "upload.jsp?fileName=" + file.name,     // target url
                                true                                    // let's be specific
                        );
                        xhr.overrideMimeType("application/octet-stream");

                        // It seems that sendAsBinary is deprecated.
                        // Use send instead(which has so many overrides)
                        xhr.onreadystatechange = function() {
                            if (xhr.readyState == 4) {
                                if (xhr.status == 200) {
                                    console.log("upload complete");
                                    console.log("response: " + xhr.responseText);
                                }
                            }
                        };
                        //xhr.sendAsBinary(reader.result);
                        console.log("OK, I am about to upload");
                        xhr.send(reader.result);
                    }
                };
                reader.readAsBinaryString(file);
            } else {
                alert("Please choose a file.");
            }
        } //Function ends here.
    </script>
</head>

<h1>File API Demo</h1>
<p>
    <!-- 用于文件上传的表单元素 -->
    <form name="demoForm" id="demoForm" method="post" enctype="multipart/form-data"
          action="javascript: uploadAndSubmit();">
        <p>Upload File: <input type="file" name="file" /></p>
        <p><input type="submit" value="Submit" /></p>
    </form>

    <div>Progessing (in Bytes):
        <span id="bytesRead"></span> /
        <span id="bytesTotal"></span>
    </div>
</p>
</body>